name: 05 - Train XGBoost Model

# Triggered by 04-check-training.yml hoáº·c thá»§ cÃ´ng
on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Region (XSMB hoáº·c XSMN)'
        required: true
        default: 'XSMB'
      province:
        description: 'Province slug (all cho XSMB, hoáº·c tp-hcm, dong-nai, ...)'
        required: true
        default: 'all'
      version:
        description: 'Model version (tá»± Ä‘á»™ng náº¿u Ä‘á»ƒ trá»‘ng)'
        required: false
        default: ''
      weekday:
        description: 'Weekday Ä‘á»ƒ train (0=T2..6=CN, Ä‘á»ƒ trá»‘ng = train táº¥t cáº£)'
        required: false
        default: ''

jobs:
  train:
    name: Train XGBoost for ${{ inputs.region }}/${{ inputs.province }}
    runs-on: ubuntu-latest
    timeout-minutes: 30  # XGBoost tabular ráº¥t nhanh, 30 phÃºt lÃ  thá»«a

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train XGBoost Model
        id: train
        env:
          SUPABASE_URL:        ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:    ${{ secrets.TELEGRAM_CHAT_ID }}
          PYTHONPATH: .
        run: |
          PROVINCE="${{ inputs.province }}"
          VERSION="${{ inputs.version }}"
          WEEKDAY="${{ inputs.weekday }}"

          CMD="python src/scripts/train_xgb.py --region ${{ inputs.region }} --province ${PROVINCE}"
          if [ -n "${VERSION}" ]; then
            CMD="${CMD} --version ${VERSION}"
          fi
          if [ -n "${WEEKDAY}" ]; then
            CMD="${CMD} --weekday ${WEEKDAY}"
          fi

          echo "Running: ${CMD}"
          ${CMD}

      - name: "ðŸš¨ Notify Telegram - 05 Training Failed"
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MSG="ðŸš¨ <b>05 - Training FAILED</b>%0A"
          MSG+="ðŸŽ¯ ${{ inputs.region }}/${{ inputs.province }} wd=${{ inputs.weekday }}%0A"
          MSG+="ðŸ“… $(date -u '+%Y-%m-%d %H:%M UTC')%0A"
          MSG+="ðŸ”— <a href='${RUN_URL}'>View Logs</a>"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MSG}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true"
