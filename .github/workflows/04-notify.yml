name: 04 - Send Telegram Notifications

# Ch·∫°y h√†ng ng√†y l√∫c 7:00 GMT+7 (00:00 UTC)
on:
  schedule:
    - cron: '0 0 * * *'  # 7:00 GMT+7
  workflow_dispatch:

jobs:
  notify-predictions:
    name: Send Daily Predictions to Telegram
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Send All Predictions
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import asyncio
          from src.bot.telegram_bot import LotteryNotifier
          from src.database.supabase_client import LotteryDB
          from datetime import datetime, timedelta
          
          async def main():
              print('üì± Sending daily predictions to Telegram...')
              print('=' * 60)
              
              db = LotteryDB()
              bot = LotteryNotifier()
              today = datetime.now().date()
              
              # === XSMB Prediction ===
              print('\nüéØ XSMB Prediction...')
              xsmb_pred = db.get_prediction_by_date(today, 'XSMB')
              
              if xsmb_pred:
                  message = f'''
üéØ <b>D·ª∞ ƒêO√ÅN XSMB - {today.strftime(\"%d/%m/%Y\")}</b>

üîÆ S·ªë d·ª± ƒëo√°n: <code>{xsmb_pred[\"predicted_numbers\"][\"predicted_number\"]}</code>
üìä ƒê·ªô tin c·∫≠y: {xsmb_pred[\"confidence_score\"]*100:.0f}%
üî• S·ªë n√≥ng: {', '.join(map(str, xsmb_pred[\"predicted_numbers\"][\"hot_numbers\"][:5]))}

<i>Model: {xsmb_pred[\"model_version\"]}</i>
                  '''
                  
                  success = await bot.send_message(message)
                  if success:
                      print('   ‚úÖ XSMB sent')
                  else:
                      print('   ‚ùå XSMB failed')
              else:
                  print('   ‚ö†Ô∏è No XSMB prediction found')
              
              await asyncio.sleep(2)
              
              # === XSMN Predictions (All Provinces) ===
              print('\nüéØ XSMN Predictions (All Provinces)...')
              
              provinces = {
                  'tp-hcm': 'TP.HCM',
                  'dong-thap': 'ƒê·ªìng Th√°p',
                  'ca-mau': 'C√† Mau',
                  'ben-tre': 'B·∫øn Tre',
                  'vung-tau': 'V≈©ng T√†u',
                  'bac-lieu': 'B·∫°c Li√™u',
                  'dong-nai': 'ƒê·ªìng Nai',
                  'can-tho': 'C·∫ßn Th∆°',
                  'soc-trang': 'S√≥c TrƒÉng',
                  'tay-ninh': 'T√¢y Ninh',
                  'an-giang': 'An Giang',
                  'binh-thuan': 'B√¨nh Thu·∫≠n',
                  'vinh-long': 'Vƒ©nh Long',
                  'binh-duong': 'B√¨nh D∆∞∆°ng',
                  'tra-vinh': 'Tr√† Vinh',
                  'long-an': 'Long An',
                  'binh-phuoc': 'B√¨nh Ph∆∞·ªõc',
                  'hau-giang': 'H·∫≠u Giang',
                  'tien-giang': 'Ti·ªÅn Giang',
                  'kien-giang': 'Ki√™n Giang',
                  'da-lat': 'ƒê√† L·∫°t'
              }
              
              # G·ªôp t·∫•t c·∫£ predictions v√†o 1 message
              xsmn_message = f'üéØ <b>D·ª∞ ƒêO√ÅN XSMN - {today.strftime(\"%d/%m/%Y\")}</b>\n\n'
              
              found_count = 0
              for province_code, province_name in provinces.items():
                  pred = db.get_prediction_by_date(today, 'XSMN', province_code)
                  
                  if pred:
                      pred_num = pred['predicted_numbers']['predicted_number']
                      confidence = pred['confidence_score'] * 100
                      xsmn_message += f'üìç <b>{province_name}</b>: <code>{pred_num}</code> ({confidence:.0f}%)\n'
                      found_count += 1
              
              if found_count > 0:
                  xsmn_message += f'\n<i>T·ªïng: {found_count}/21 t·ªânh</i>'
                  success = await bot.send_message(xsmn_message)
                  
                  if success:
                      print(f'   ‚úÖ XSMN sent ({found_count} provinces)')
                  else:
                      print('   ‚ùå XSMN failed')
              else:
                  print('   ‚ö†Ô∏è No XSMN predictions found')
              
              print('\n' + '=' * 60)
              print('‚úÖ Notification workflow completed!')
          
          asyncio.run(main())
          "
