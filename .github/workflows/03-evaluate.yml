name: 03 - Evaluate Predictions

# Ch·∫°y l√∫c 19:30 GMT+7 (12:30 UTC)
# Sau khi crawl xong, ƒë√°nh gi√° predictions h√¥m qua
on:
  schedule:
    - cron: '30 12 * * *'  # 19:30 GMT+7
  workflow_dispatch:

jobs:
  evaluate-xsmb:
    name: Evaluate XSMB Predictions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Evaluate Yesterday's Predictions
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import asyncio
          from src.database.supabase_client import LotteryDB
          from src.bot.telegram_bot import LotteryNotifier
          from datetime import datetime, timedelta
          
          async def main():
              print('üìä Evaluating XSMB predictions...')
              
              db = LotteryDB()
              try:
                  bot = LotteryNotifier()
              except Exception as e:
                  print(f'‚ö†Ô∏è Could not init bot: {e}')
                  bot = None
                  
              # Use Vietnam Time (UTC+7)
              vn_now = datetime.utcnow() + timedelta(hours=7)
              yesterday = (vn_now - timedelta(days=1)).date()
              print(f'Current Vietnam Time: {vn_now}')
              print(f'Evaluation Date (Yesterday): {yesterday}')
              
              # L·∫•y d·ª± ƒëo√°n h√¥m qua
              prediction = db.get_prediction_by_date(yesterday, 'XSMB')
              
              if not prediction:
                  print(f'‚ö†Ô∏è No prediction found for {yesterday}')
                  if bot: await bot.send_message(f'‚ö†Ô∏è <b>XSMB Evaluation</b>: No prediction found for {yesterday}')
                  exit(0)  # Kh√¥ng fail workflow
              
              # L·∫•y k·∫øt qu·∫£ th·ª±c t·∫ø
              actual = db.get_draw_by_date(yesterday, 'XSMB')
              
              if not actual:
                  print(f'‚ö†Ô∏è No actual results found for {yesterday}')
                  print(f'   Results might not be available yet')
                  if bot: await bot.send_message(f'‚ö†Ô∏è <b>XSMB Evaluation</b>: No actual results found for {yesterday}')
                  exit(0)
              
              # So s√°nh
              pred_num = prediction['predicted_numbers']['predicted_number']
              actual_num = actual['special_prize']
              
              print(f'üîç Comparison:')
              print(f'   Predicted: {pred_num}')
              print(f'   Actual:    {actual_num}')
              
              # T√≠nh s·ªë ch·ªØ s·ªë tr√πng
              correct_digits = 0
              for i, (p, a) in enumerate(zip(pred_num, actual_num)):
                  if p == a:
                      correct_digits += 1
                      print(f'   Position {i}: ‚úÖ {p} = {a}')
                  else:
                      print(f'   Position {i}: ‚ùå {p} ‚â† {a}')
              
              accuracy = correct_digits / len(actual_num) if len(actual_num) > 0 else 0
              
              # L∆∞u metrics
              metrics_data = {
                  'evaluation_date': yesterday,
                  'region': 'XSMB',
                  'total_predictions': len(actual_num),
                  'correct_predictions': correct_digits,
                  'accuracy_rate': accuracy,
                  'model_version': 'frequency_v1'
              }
              db.save_evaluation(metrics_data)
              
              print(f'‚úÖ Evaluation saved!')
              print(f'   Accuracy: {accuracy*100:.1f}% ({correct_digits}/{len(actual_num)} digits)')
              
              if bot: await bot.send_evaluation(metrics_data)

          if __name__ == '__main__':
              asyncio.run(main())
          "
  
  evaluate-xsmn:
    name: Evaluate XSMN Predictions (All Provinces)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Evaluate All Provinces
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import asyncio
          from src.database.supabase_client import LotteryDB
          from src.bot.telegram_bot import LotteryNotifier
          from datetime import datetime, timedelta
          
          async def main():
              print('üìä Evaluating XSMN predictions for all provinces...')
              print('=' * 60)
              
              provinces = [
                  'tp-hcm', 'dong-thap', 'ca-mau',
                  'ben-tre', 'vung-tau', 'bac-lieu',
                  'dong-nai', 'can-tho', 'soc-trang',
                  'tay-ninh', 'an-giang', 'binh-thuan',
                  'vinh-long', 'binh-duong', 'tra-vinh',
                  'long-an', 'binh-phuoc', 'hau-giang',
                  'tien-giang', 'kien-giang', 'da-lat'
              ]
              
              db = LotteryDB()
              try:
                  bot = LotteryNotifier()
              except Exception as e:
                  print(f'‚ö†Ô∏è Could not init bot: {e}')
                  bot = None
                  
              # Use Vietnam Time (UTC+7)
              vn_now = datetime.utcnow() + timedelta(hours=7)
              yesterday = (vn_now - timedelta(days=1)).date()
              print(f'Current Vietnam Time: {vn_now}')
              print(f'Evaluation Date (Yesterday): {yesterday}')
              
              total_evaluated = 0
              total_accuracy = 0.0
              
              for province in provinces:
                  try:
                      print(f'\nüìç {province.upper()}...')
                      
                      # L·∫•y prediction cho t·ªânh n√†y
                      prediction = db.get_prediction_by_date(yesterday, 'XSMN', province)
                      
                      if not prediction:
                          print(f'   ‚ö†Ô∏è No prediction found')
                          continue
                      
                      # L·∫•y k·∫øt qu·∫£ th·ª±c t·∫ø
                      actual = db.get_draw_by_date(yesterday, 'XSMN', province)
                      
                      if not actual:
                          print(f'   ‚ö†Ô∏è No actual results found')
                          continue
                      
                      # So s√°nh
                      pred_num = prediction['predicted_numbers']['predicted_number']
                      actual_num = actual['special_prize']
                      
                      correct_digits = sum(1 for p, a in zip(pred_num, actual_num) if p == a)
                      accuracy = correct_digits / len(actual_num) if len(actual_num) > 0 else 0
                      
                      # L∆∞u evaluation
                      db.save_evaluation({
                          'evaluation_date': yesterday,
                          'region': 'XSMN',
                          'total_predictions': len(actual_num),
                          'correct_predictions': correct_digits,
                          'accuracy_rate': accuracy,
                          'model_version': 'frequency_v1'
                      })
                      
                      print(f'   Predicted: {pred_num}')
                      print(f'   Actual:    {actual_num}')
                      print(f'   ‚úÖ Accuracy: {accuracy*100:.1f}% ({correct_digits}/{len(actual_num)})')
                      
                      total_evaluated += 1
                      total_accuracy += accuracy
                      
                  except Exception as e:
                      print(f'   ‚ùå Error: {e}')
              
              print('\n' + '=' * 60)
              if total_evaluated > 0:
                  avg_accuracy = (total_accuracy / total_evaluated)
                  print(f'üìä Summary:')
                  print(f'   Evaluated: {total_evaluated}/{len(provinces)} provinces')
                  print(f'   Average accuracy: {avg_accuracy*100:.1f}%')
                  
                  # G·ª≠i b√°o c√°o t·ªïng h·ª£p cho XSMN (ch·ª© kh√¥ng g·ª≠i t·ª´ng t·ªânh s·∫Ω b·ªã spam)
                  metrics_data = {
                      'evaluation_date': yesterday,
                      'region': 'XSMN (Avg)',
                      'total_predictions': 6, # dummy
                      'correct_predictions': 0, # dummy
                      'accuracy_rate': avg_accuracy,
                      'model_version': 'frequency_v1'
                  }
                  if bot: await bot.send_evaluation(metrics_data)
                  
              else:
                  print('‚ö†Ô∏è No evaluations completed')
                  if bot: await bot.send_message(f'‚ö†Ô∏è <b>XSMN Evaluation</b>: No evaluations completed for {yesterday}')
              print('=' * 60)

          if __name__ == '__main__':
              asyncio.run(main())
          "
