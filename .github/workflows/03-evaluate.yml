name: 03 - Evaluate Predictions

# Cháº¡y lÃºc 19:30 GMT+7 (12:30 UTC)
# Sau khi crawl xong, Ä‘Ã¡nh giÃ¡ predictions hÃ´m qua
on:
  schedule:
    - cron: '30 12 * * *'  # 19:30 GMT+7
  workflow_dispatch:

jobs:
  evaluate-xsmb:
    name: Evaluate XSMB Predictions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Evaluate Yesterday's Predictions
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          python -c "
          from src.database.supabase_client import LotteryDB
          from datetime import datetime, timedelta
          
          print('ðŸ“Š Evaluating XSMB predictions...')
          
          db = LotteryDB()
          yesterday = (datetime.now() - timedelta(days=1)).date()
          
          # Láº¥y dá»± Ä‘oÃ¡n hÃ´m qua
          prediction = db.get_prediction_by_date(yesterday, 'XSMB')
          
          if not prediction:
              print(f'âš ï¸ No prediction found for {yesterday}')
              exit(0)  # KhÃ´ng fail workflow
          
          # Láº¥y káº¿t quáº£ thá»±c táº¿
          actual = db.get_draw_by_date(yesterday, 'XSMB')
          
          if not actual:
              print(f'âš ï¸ No actual results found for {yesterday}')
              print(f'   Results might not be available yet')
              exit(0)
          
          # So sÃ¡nh
          pred_num = prediction['predicted_numbers']['predicted_number']
          actual_num = actual['special_prize']
          
          print(f'ðŸ” Comparison:')
          print(f'   Predicted: {pred_num}')
          print(f'   Actual:    {actual_num}')
          
          # TÃ­nh sá»‘ chá»¯ sá»‘ trÃ¹ng
          correct_digits = 0
          for i, (p, a) in enumerate(zip(pred_num, actual_num)):
              if p == a:
                  correct_digits += 1
                  print(f'   Position {i}: âœ… {p} = {a}')
              else:
                  print(f'   Position {i}: âŒ {p} â‰  {a}')
          
          accuracy = correct_digits / len(actual_num) if len(actual_num) > 0 else 0
          
          # LÆ°u metrics
          db.save_evaluation({
              'evaluation_date': yesterday,
              'region': 'XSMB',
              'total_predictions': len(actual_num),
              'correct_predictions': correct_digits,
              'accuracy_rate': accuracy,
              'model_version': 'frequency_v1'
          })
          
          print(f'âœ… Evaluation saved!')
          print(f'   Accuracy: {accuracy*100:.1f}% ({correct_digits}/{len(actual_num)} digits)')
          "
  
  evaluate-xsmn:
    name: Evaluate XSMN Predictions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Evaluate Yesterday's Predictions
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          python -c "
          from src.database.supabase_client import LotteryDB
          from datetime import datetime, timedelta
          
          print('ðŸ“Š Evaluating XSMN predictions...')
          
          db = LotteryDB()
          yesterday = (datetime.now() - timedelta(days=1)).date()
          
          prediction = db.get_prediction_by_date(yesterday, 'XSMN')
          
          if not prediction:
              print(f'âš ï¸ No prediction found for {yesterday}')
              exit(0)
          
          actual = db.get_draw_by_date(yesterday, 'XSMN')
          
          if not actual:
              print(f'âš ï¸ No actual results found for {yesterday}')
              exit(0)
          
          pred_num = prediction['predicted_numbers']['predicted_number']
          actual_num = actual['special_prize']
          
          print(f'ðŸ” Comparison:')
          print(f'   Predicted: {pred_num}')
          print(f'   Actual:    {actual_num}')
          
          correct_digits = sum(1 for p, a in zip(pred_num, actual_num) if p == a)
          accuracy = correct_digits / len(actual_num) if len(actual_num) > 0 else 0
          
          db.save_evaluation({
              'evaluation_date': yesterday,
              'region': 'XSMN',
              'total_predictions': len(actual_num),
              'correct_predictions': correct_digits,
              'accuracy_rate': accuracy,
              'model_version': 'frequency_v1'
          })
          
          print(f'âœ… Evaluation saved! Accuracy: {accuracy*100:.1f}%')
          "
