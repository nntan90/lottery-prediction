name: 01 - Daily Lottery Crawl

# Cháº¡y hÃ ng ngÃ y lÃºc 19:00 GMT+7 (12:00 UTC)
on:
  schedule:
    - cron: '0 12 * * *'  # 19:00 GMT+7
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Crawl XSMB (Miá»n Báº¯c) - Ä‘á»™c láº­p
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  crawl-xsmb:
    name: Crawl XSMB (Miá»n Báº¯c)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Crawl XSMB Results
        id: crawl_xsmb
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PYTHONPATH: .
        run: |
          python src/scripts/crawl_xsmb.py

      - name: "ğŸš¨ Notify Telegram - XSMB Failed"
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MSG="ğŸš¨ <b>XSMB Crawl FAILED</b>%0A"
          MSG+="ğŸ“… $(date -u '+%Y-%m-%d %H:%M UTC')%0A"
          MSG+="ğŸ”— <a href='${RUN_URL}'>View Logs</a>%0A"
          MSG+="âš ï¸ Job bá»‹ lá»—i hoáº·c bá»‹ terminate. Kiá»ƒm tra GitHub Actions."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MSG}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Crawl XSMN (Miá»n Nam) - Ä‘á»™c láº­p
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  crawl-xsmn:
    name: Crawl XSMN (Miá»n Nam)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Crawl XSMN Results
        id: crawl_xsmn
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PYTHONPATH: .
        run: |
          python src/scripts/crawl_xsmn.py

      - name: "ğŸš¨ Notify Telegram - XSMN Failed"
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MSG="ğŸš¨ <b>XSMN Crawl FAILED</b>%0A"
          MSG+="ğŸ“… $(date -u '+%Y-%m-%d %H:%M UTC')%0A"
          MSG+="ğŸ”— <a href='${RUN_URL}'>View Logs</a>%0A"
          MSG+="âš ï¸ Job bá»‹ lá»—i hoáº·c bá»‹ terminate. Kiá»ƒm tra GitHub Actions."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MSG}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true"


